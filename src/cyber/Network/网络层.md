---
category: 计算机网络
order: 4
---
![网络层](网络层.png)

# 网络层

## 概述

### 两个观点

- 让网络负责可靠交付

- 网络提供数据报服务

### 两种服务

- 虚电路服务

- 数据报服务

### 两个层面

- 控制面

- 转发面（数据面

## 网际协议IP

### 虚拟互连网络

### IP地址

- 32位

- 二级结构

	- 网络号，主机号

- 分类

	- A类

		- 前8位网络号，第一位为0

			- 1～126

	- B类

		- 前16位网络号，前两位为10

			- 128.1～191.255

	- C类

		- 前24位网络号，前三位为110

			- 192.0.1~223.255.255

	- D类

		- 多播地址

			- 前4位为1110

	- E类

		- 保留地址

			- 前4位为1111

- 专有地址

	- 10.0.0.0~10.255.255.255

	- 172.16.0.0~172.32.255.255

	- 192.168.0.0~192.168.255.255

- 特殊地址

	- 全1

		- 在本网络上广播，路由器不转发

	- 主机号全1

		- 对本网络号上的所有主机广播

	- 全0

		- 网络主机

	- 主机号全0

		- 本网络上的某台主机

	- 127.0.0.1

		- 环回地址

### 无分类编址CIDR

- 全名：无分类域间路由选择CIDR

- 网络前缀

	- 将IP中的网络号改称为“网络前缀”

	- 位数不固定，0~32

- 地址块

- 地址掩码(子网掩码)(address mask)

	- 32位

	- 由一连串1和接着的一连串0组成

	- 目的：让机器从IP地址迅速算出网络地址

	- 网络地址 = 二进制IP地址 AND 子网掩码

	- 划分IP子网

		- 概念

			- 将IP地址的两级结构扩充位三级结构

			- 向高位主机号借位

			- 常常结合VLAN技术

		- 划分方法

			- 高序占用主机号前m位，得到2^m个子网

			- 主机号余位n，每个子网2^n-2个主机（减去全0全1）

	- IP超网

		- 向低位网络号借位

### IP地址与MAC地址

- MAC-数据链路层 IP-网络层及以上

- 地址解析协议ARP

	- 根据网络层使用的IP地址，解析出数据链路层使用的硬件地址

	- 作用范围：直连的网络（同一个二层广播网络）

	- ARP请求-广播；ARP响应-单播

	- 请求方广播，相应IP的主机回应，请求方收到后写入ARP缓存

	- ARP缓存

		- 存放最近获得的IP地址到MAC地址的绑定，以减少ARP广播的数量

- 逆地址解析协议RARP

	- 使只知道自己MAC地址的主机能够通过协议RARP找出其IP地址

### IP数据报

- 首部（20-60字节

	- 固定部分20字节

		- 版本：4位

		- 首部长度：4位

		- 区分服务：8位

		- 总长度：16位

		- 标识：16位

		- 标志：3位

			- 最低位MF（More Fragment）

			- 中间的一位DF（Don't Fragment）

			- 只有0和1

		- 片偏移：13位

			- 分片后，某片在原分组中的相对位置

			- 单位：8个字节

		- 生存时间TTL：8位

			- 单位：跳数

		- 协议：8位

			- 判断给谁

		- 首部校验和：16位

			- 只检验数据报的首部（不包括数据部分）

			- 反码算术运算

				- 发送方：把数据报首部分为多个16位字的序列，并把校验和字段置零，将所有字段相加后取反，加入校验和字段；接收方：将包含校验和的所有字段相加后取反，结果为0则保留

			- 数据报每经过一个路由器，都要重新算一次首部校验和（首部变化）

		- 源地址：32位

		- 目的地址：32位

	- 可变部分0-40字节

- 转发方式

	- 同网络直接交付

	- 不同网络间接交付

## IP层转发分组

### 路由器转发过程

- 折帧

	- 拆开数据帧1，取出IP包，提取目的IP地址

- 查表

	- 查找路由表，找到目标子网对应的路由器接口

- 封帧

	- 产生新的数据帧，将帧2从接口转发

### 路由表

- 目的网络/掩码

- 协议类型

- 开销

- 优先级

- 标志

- 下一跳

- 出接口

### 最长前缀匹配

- 多个匹配的前缀，选择前缀最长的

### 分组转发算法

- AND与运算：目的地址 与 本网络子网掩码

- 路由

	- 主机路由

	- 最长前缀匹配

	- 默认路由

### 路由决策原则

- 最长匹配原则

- 最小管理距离原则

- 最小度量值原则

## 网际控制报文协议ICMP

### 种类

- ICMP差错报告报文

	- 终点不可达（类型值3）

	- 时间超过（类型值11）

		- Traceroute

	- 参数问题（类型值12）

	- 改变路由（重定向）（类型值5）

	- 格式：ICMP的前8字节+IP数据报首部+数据字段前8字节

- ICMP询问报文

	- 回送请求或回送回答（类型值8或0）

		- PING

	- 时间戳请求或时间戳回答（类型值13或14）

## IPv6

### 解决IPv4地址耗尽

### 主要变化

- 更大的地址空间（128位）

	- IPv4为32位

- 扩展的地址层次结构

	- 地址空间大，可划分为更多的层次

- 灵活的首部格式

	- 定义了许多可选的扩展首部

- 改进的选项

	- 允许数据报包含有选项的控制信息，因而可包含新的选项

- 允许协议继续扩充

	- IPv4的功能是固定不变的

- 支持即插即用（即自动配置）

	- 不需要使用DHCP

- 支持资源的预分配

	- 支持实时视像等要求保证一定的带宽和时延的应用

- 首部改为8字节对齐（长度为8字节的整数倍）

	- IPv4为4字节对齐

### 组成部分

- 基本首部(base header)

	- 40字节

	- 字段

		- 版本（4位）

		- 通信量类（8位）

		- 流标号（20位）

		- 有效载荷长度（16位）

		- 下一个首部（8位）

		- 跳数限制（8位）

		- 源地址（128位）

		- 目的地址（128位）

- 有效载荷(payload)(净载荷)

	- 不超过65535字节

	- 允许有零个或多个拓展首部(extension header)

### IPv6的地址

- 基本类型地址

	- 单播

	- 多播

	- 任播

- 记法

	- 点分十进制

	- 冒号十六进制

## 路由选择协议

### 概念

- 动态

- 内部网关协议IGP、外部网关协议EGP

	- 内部

		- RIP

		- OSPF

	- 外部

		- BGP

- 基于距离矢量、基于链路状态

- 域间路由选择、域内路由选择

	- 域内

		- RIP

		- OSPF

	- 域间

		- BGP

### RIP

- 基于距离向量

	- “跳数”不大于15

	- 收到RIP报文，修改：“下一跳”地址，“距离”+1

	- 若原路由表无目的网络Net，则添加；否则，若“下一跳”路由器地址恰好为发RIP报文的路由器，无条件替换相应路由表；否则，比“距离”大小，若新的较小，则更新。

- UDP，端口号520

- 特点

	- 仅和相邻路由器交换信息（广播）

	- 交换自己现在的路由表

	- 按固定时间间隔交换路由信息

- 优缺点

	- 好消息传播快，坏消息传播慢

### OSPF

- 基于链路状态

- IP，协议号89

- 特点

	- 向本自治系统中所有路由器发送消息

		- 洪泛法

			- 路由器通过所有输出端口向所有相邻的路由器发送消息

			- 每一个相邻路由器又再将此消息发往其所有相邻路由器（不发给发来消息的那个路由器）

	- 发送：本路由器相邻的所有路由器的链路状态

		- “链路状态”：与那些路由器相邻，以及该链路的“度量”

	- 当链路状态发生变化/每隔一段时间更新

- 其他特点

	- 对于不同类型的业务可计算出不同的路由

	- 可实现多路径间的负载均衡

	- 支持可变长度的子网划分和无分类编址CIDR

- 优点

	- 更新过程收敛得快

- 划分区域

	- 将一个自治系统划分为若干个更小的范围

	- 优点

		- 减少整个网络上的通信量

		- 减少需要维护的状态数量

		- 加速收敛

		- 限制不稳定到一个区域

		- 提高网络性能

	- 缺点

		- 交换信息的种类增多

		- 使OSPF协议更复杂

- OSPF路由计算过程

	- 生成、发送LSA

	- 集合LSA，生成LSDB

	- 将LSDP转换为带权有向图

	- 生成以自己为根的最短路径树

- 五种分组类型

	- 问候（Hello）

	- 数据库描述（DBD）

	- 链路状态请求（LSR）

	- 链路状态更新（LSU）

	- 链路状态确认（LSAck）

- 工作流程

	- 建立路由器的邻居关系

	- 进行必要的DR/BDR选举

	- 链路状态数据库的同步

	- 产生路由表

	- 维护路由信息

### BGP

- 基于路径

- TCP，端口号179

- BGP路由

	- 边界路由器（边界网关）（eBGP）

	- 内部路由器（iBGP）

	- iBGP可转发给eBGP，反之亦可

	- iBGP之间不可转发

	- eBGP不可将来自iBGP的信息转发给另一个iBGP

- BGP的路由选择（有序）

	- 1.本地偏好LOCAL-PREF值最高的

	- 2.AS跳数最少的

	- 3.使用热土豆路由选择算法

	- 4.BGP标识符的数值最小的

### 路由器的构成

- 结构

	- 路由选择

		- 控制层面（软件）

	- 分组转发

		- 数据层面（硬件）

## IP多播

### 概念

### 硬件多播

### IGMP协议

### 多播路由选择协议

